name: Trivy Security Scan

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  security-scan:
    name: Generate SBOM, Vulnerability Report, and VEX
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.2'

      - name: Download Go modules
        run: go mod download

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb generic main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Generate SBOM (SPDX tag-value format)
        run: |
          trivy fs \
            --format spdx \
            --output SBOM.spdx \
            --list-all-pkgs \
            .

      - name: Generate Vulnerability Report (table format)
        run: |
          trivy fs \
            --format table \
            --output vulnerability-report.txt \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            . || true

      - name: Generate VEX Document (YAML format)
        run: |
          # Generate JSON output for parsing
          trivy fs \
            --format json \
            --output trivy-results.json \
            --list-all-pkgs \
            . || true

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Create VEX header
          cat > VEX.yaml << EOF
          # OpenVEX Document in YAML Format
          # Generated from Trivy security scan
          # https://github.com/openvex/spec

          "@context": "https://openvex.dev/ns/v0.2.0"
          "@id": "https://github.com/${{ github.repository }}/security/vex"
          author: "${{ github.repository_owner }}"
          role: "Document Creator"
          timestamp: "${TIMESTAMP}"
          version: 1
          tooling: "trivy + github-actions"

          product:
            "@id": "pkg:golang/${{ github.repository }}"
            name: "${{ github.event.repository.name }}"
            version: "${{ github.sha }}"

          # Vulnerability Statements
          # Status values: not_affected, affected, fixed, under_investigation
          statements:
          EOF

          # Parse vulnerabilities from Trivy JSON and append to VEX
          if [ -f trivy-results.json ]; then
            VULN_COUNT=$(jq '[.Results[]? | select(.Vulnerabilities != null) | .Vulnerabilities[]] | length' trivy-results.json 2>/dev/null || echo "0")

            if [ "$VULN_COUNT" -gt 0 ]; then
              jq -r '
                [.Results[]? | select(.Vulnerabilities != null) | .Vulnerabilities[]] |
                unique_by(.VulnerabilityID) |
                .[] |
                "  - vulnerability:\n      \"@id\": \"\(.VulnerabilityID)\"\n      name: \"\(.VulnerabilityID)\"\n      description: \"\(.Title // "No description available" | gsub("[\"\\n\\r]"; " "))\"\n    status: \"under_investigation\"\n    justification: \"Automatically detected by Trivy scan\"\n    action_statement: \"Review and assess applicability\""
              ' trivy-results.json >> VEX.yaml
            else
              echo "  []  # No vulnerabilities found" >> VEX.yaml
            fi
          else
            echo "  []  # No scan results available" >> VEX.yaml
          fi

          # Clean up temporary file
          rm -f trivy-results.json

      - name: Commit security artifacts
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add SBOM.spdx vulnerability-report.txt VEX.yaml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update security scan artifacts

          - SBOM.spdx: Software Bill of Materials (SPDX tag-value format)
          - vulnerability-report.txt: Trivy vulnerability scan results
          - VEX.yaml: Vulnerability Exploitability Exchange document

          Generated by Trivy security scan workflow"

            git push
          fi
